<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title></title>
    <style>
        .completed{
            text-decoration: line-through;
            color: gray;
        }
    </style>
    <link rel="stylesheet" href="./css/bootstrap.min.css">
    <script src="js/underscore.js"></script>
    <script src="js/jquery.js"></script>
    <script src="js/backbone.js"></script>
    <script src="js/backbone-nested-models.js"></script>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script src="//www.parsecdn.com/js/parse-1.6.2.min.js"></script>
    <script src="js/app.js"></script>
</head>
<body>
<!-- Static navbar -->
<nav class="navbar navbar-default navbar-static-top">
    <div class="container">
        <div class="navbar-header">
            <a class="navbar-brand" href="#">Imayaru</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li class="active"><a href="#">Home</a></li>
                <li><a href="#about">About</a></li>
                <li><a href="#contact">Contact</a></li>
                <li id="logout"><a href="./login.html/">LogOut</a></li>

            </ul>

        </div><!--/.nav-collapse -->
    </div>
</nav>
<div class="container">
<div class="row">
<div class="col-md-8">
    <h1>Tasks</h1>
<form id="addTask">
    <input type="text" id ="title">
    <input type="submit"class="todoClass" value="add">
    <span id="error"></span>
</form>


<div id="tasks">
    <ul class="tasks-uncompleted">

    </ul>
</div>
<p>Tasks:left <span id="count"></span></p>

</div>
<div class="col-md-4">
    </div>
</div>
</div>

<script type="text/template" id="task-template">
    <input type="checkbox" class="toggle" <%= completed ? 'checked': '' %>>
    <span class="<%= completed ? 'completed' : '' %>">
            <%- title %>
        </span>

    <span class="delete">[X]</span>
</script>

<script type="text/javascript">
    /*globalにして関数から呼び出せるようにしておく*/
    Parse.initialize("5R4FX9XGUVWgEGEdUz2dTxjvZsYlxJswNbht98Ga", "E7IvAMZ7Bs9Hczwdgx5ktIO2OJ0pxV1N6vFwXsuH");

    function saveTodoData(text, user){

        var tasks = new Task();
        tasks.set("title",text);

    }
    function obtainDataFromParseDB(){
        var tasks = Parse.Object.extend("Task");
        var query = new Parse.Query(tasks);
        query.equalTo('completed','false')
        query.find({
           success: function(results){
               console.log(results.length);
               console.log(results);
               //javascriptのオブジェクトのプロパティのアクセス方法を調べる
           },
            error: function(error){
                //do something
            }
        });
    }

    var Task = Parse.Object.extend("Task",{
        completed: false,
        title: ""
    });

    function createTitleString(name){
       var titleLabel =  "<li>" + name + "</li>";
        return titleLabel;
    }
    function printTodo(element, index, array){
        console.log(index+ element.get("title"));

        var titileStr = createTitleString(element.get("title"));
        $(function(){
            $('.tasks-uncompleted').append(titileStr);;
        });
    }
    function findTodo(){/*データベースから*/
        var user = Parse.User.current();
        var relation = user.relation("tasks");/*relational*/

        relation.query().find({
           success: function(list){
               console.log(list)
               list.forEach(printTodo);
           }
        });
    }
    $(function(){

        findTodo();
//       console.log("即時実行"+Task);


        var currentUser = sessionStorage.getItem("user");/*セッションから値を取得*/
        if(currentUser == null){
            location.href="./login.html";
        }

        var UserTasks = Parse.Object.extend("");

        $('.todoClass').click(function(event){
           event.preventDefault();//画面のリロードを防ぐ
            var todoText = $('#title').val();
            tasks = new Task({
                        title: todoText,
                        completed: false
                    }
            );
            var user = Parse.User.current();
            var relation = user.relation("tasks");
            tasks.save({
               success: function(){
                   relation.add(tasks);
                   user.save();

               } ,error: function(){
                    console.log("save has failed");
                }
            });
        });

        $('#logout').click(function(event){
            event.preventDefault();//画面のリロードを防ぐ
            var username = $('#login-username').val();
            var password = $('#login-password').val();
            Parse.User.logOut();
            location.href="./login.html";
        });

    });



</script>
</body>
</html>